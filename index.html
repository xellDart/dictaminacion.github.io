<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NebuIA - Sistema de Dictaminación Legal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
        }
        
        /* Animaciones suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Botones estilo ChatGPT */
        .btn-primary {
            background-color: #000000;
            color: white;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #333333;
        }
        
        .btn-secondary {
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        
        /* Campos de entrada estilo ChatGPT */
        .input-field {
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: #000000;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
        }
        
        /* Cards minimalistas */
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Tabs minimalistas */
        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        
        .tab-active {
            color: #000000;
            border-bottom: 2px solid #000000;
        }
        
        /* Estados de documentos */
        .doc-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .doc-status-success {
            background-color: #f0fdf4;
            color: #166534;
        }
        
        .doc-status-optional {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        /* Dictamen styles */
        .dictamen-section {
            background-color: #f9fafb;
            margin: 15px 0;
            padding: 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        .dictamen-section-title {
            background-color: #000000;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .dictamen-section-content {
            padding: 16px;
            background-color: #ffffff;
        }
        
        /* Sección vigente especial */
        .vigent-section {
            border: 2px solid #10b981;
            margin: 15px 0;
        }
        
        .vigent-section-title {
            background-color: #10b981;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Loading animation */
        .loading-dots {
            display: inline-flex;
            align-items: center;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #000000;
            border-radius: 50%;
            display: inline-block;
            animation: loading 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Tag input styles */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            min-height: 42px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #ffffff;
            transition: all 0.2s;
        }
        
        .tag-input-container:focus-within {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .tag-remove {
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }
        
        .tag-remove:hover {
            color: #ef4444;
        }
        
        .tag-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.875rem;
            min-width: 200px;
        }

        /* Estilos para dictamen tipo Bancrea */
        .dictamen-header {
            background-color: #1e3a5f;
            color: white;
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
        }

        .dictamen-table {
            width: 100%;
            font-size: 10px;
            border-collapse: collapse;
        }

        .dictamen-table td {
            padding: 6px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
        }

        .dictamen-table th {
            padding: 6px;
            border: 1px solid #e5e7eb;
            background-color: #f3f4f6;
            font-weight: 600;
            text-align: left;
        }

        .documento-chronologico {
            border-bottom: 1px dashed #d1d5db;
            padding: 10px 0;
            font-size: 10px;
            line-height: 1.5;
        }
    </style>
</head>
<body class="bg-white">
    <!-- Header minimalista -->
    <header class="border-b border-gray-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">Sistema de Dictaminación Legal</h1>
                    <p class="text-sm text-gray-500 mt-0.5">Análisis inteligente de documentos corporativos</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-500">v2.0</span>
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-balance-scale text-gray-600 text-xs"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 max-w-7xl">
        <!-- Input Section (collapsible) -->
        <div id="inputSection" class="card p-6 mb-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Ingreso de Documentos</h2>
                    <p class="text-sm text-gray-500 mt-1">Ingrese los IDs de los documentos a analizar. Solo el ID es obligatorio si desea analizar un único documento.</p>
                </div>
                <button onclick="toggleInputSection()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-chevron-up" id="toggleIcon"></i>
                </button>
            </div>
            
            <div id="inputFields" class="space-y-4">
                <!-- Document inputs con indicadores -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Acta Constitutiva
                            <span class="doc-status doc-status-optional ml-2">Opcional</span>
                        </label>
                        <div class="relative">
                            <input type="text" 
                                   id="actaConstitutiva" 
                                   class="input-field w-full px-4 py-2.5 pr-10 rounded-lg text-sm"
                                   placeholder="ej: 12950ec4-1f35-4efc..."
                                   value="">
                            <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <i class="fas fa-building text-sm"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Poder
                            <span class="doc-status doc-status-optional ml-2">Opcional</span>
                        </label>
                        <div class="relative">
                            <input type="text" 
                                   id="poder" 
                                   class="input-field w-full px-4 py-2.5 pr-10 rounded-lg text-sm"
                                   placeholder="ej: 557d2207-c9c4-4698..."
                                   value="">
                            <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                <i class="fas fa-stamp text-sm"></i>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Actas de Asamblea con entrada múltiple -->
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Actas de Asamblea
                        <span class="doc-status doc-status-optional ml-2">Opcional - Múltiples IDs permitidos</span>
                    </label>
                    <div id="actasContainer" class="tag-input-container">
                        <input type="text" 
                               id="actasAsambleaInput" 
                               class="tag-input"
                               placeholder="Ingrese un ID y presione Enter"
                               onkeydown="handleActaInput(event)">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Presione Enter después de cada ID para agregarlo. Click en la X para eliminar.</p>
                </div>
                
                <!-- Botones de acción -->
                <div class="flex items-center justify-between mt-6">
                    <div class="flex space-x-3">
                        <button onclick="fetchDocuments()" class="btn-primary px-6 py-2.5 rounded-lg text-sm font-medium flex items-center">
                            <i class="fas fa-search mr-2"></i>
                            Analizar Documentos
                        </button>
                    </div>
                    <button onclick="clearInputs()" class="text-gray-400 hover:text-gray-600 text-sm transition-colors">
                        <i class="fas fa-eraser mr-1"></i>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Mini input collapsed -->
        <div id="miniInput" class="hidden card p-4 mb-6 fade-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Documentos analizados:</span>
                    <div class="flex space-x-2" id="analyzedDocs"></div>
                </div>
                <button onclick="toggleInputSection()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">
                    <i class="fas fa-edit mr-2"></i>
                    Modificar búsqueda
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <div class="card p-12">
                <div class="flex flex-col items-center justify-center">
                    <div class="loading-dots mb-4">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <p class="text-gray-600 text-sm">Analizando documentos</p>
                    <p class="text-gray-400 text-xs mt-1">Esto puede tomar unos segundos...</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden fade-in">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="statsCards"></div>
            
            <!-- Main Content Area -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left: Documents (2 columns) -->
                <div class="lg:col-span-2">
                    <div class="card h-[700px] flex flex-col">
                        <!-- Tabs -->
                        <div class="border-b border-gray-200 px-6 pt-4">
                            <div class="flex space-x-8" id="documentTabs"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 p-6 overflow-y-auto" id="documents-content"></div>
                    </div>
                </div>

                <!-- Right: Dictamen (1 column) -->
                <div class="lg:col-span-1">
                    <div class="card h-[700px] flex flex-col">
                        <!-- Header con acciones -->
                        <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                            <h3 class="font-semibold text-gray-900">Dictamen Jurídico</h3>
                            <div class="flex space-x-2">
                                <button onclick="exportToPDF()" class="text-gray-400 hover:text-gray-600 transition-colors" title="Exportar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                <button onclick="window.print()" class="text-gray-400 hover:text-gray-600 transition-colors" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 p-6 overflow-y-auto" id="dictamen-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Declarar variables globales al inicio
        let globalData = null;
        let activeTab = null;
        let actasIds = []; // Array para almacenar los IDs de actas
        
        let documentTypes = {
            'acta_constitutiva': { 
                name: 'Acta Constitutiva', 
                icon: 'fa-building', 
                color: 'blue' 
            },
            'poder': { 
                name: 'Poder', 
                icon: 'fa-stamp', 
                color: 'green' 
            },
            'actas_de_asamblea': { 
                name: 'Actas de Asamblea', 
                icon: 'fa-file-alt', 
                color: 'purple' 
            }
        };

        // Declarar todas las funciones al inicio
        function handleActaInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value && !actasIds.includes(value)) {
                    actasIds.push(value);
                    renderActaTags();
                    input.value = '';
                }
            }
        }
        
        function renderActaTags() {
            const container = document.getElementById('actasContainer');
            // Limpiar tags existentes
            const existingTags = container.querySelectorAll('.tag');
            existingTags.forEach(tag => tag.remove());
            
            // Agregar nuevos tags
            actasIds.forEach((id, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    <span>${id}</span>
                    <i class="fas fa-times tag-remove" onclick="removeActa(${index})"></i>
                `;
                container.insertBefore(tag, container.querySelector('.tag-input'));
            });
        }
        
        function removeActa(index) {
            actasIds.splice(index, 1);
            renderActaTags();
        }
        
        function toggleInputSection() {
            const inputSection = document.getElementById('inputSection');
            const miniInput = document.getElementById('miniInput');
            const inputFields = document.getElementById('inputFields');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (inputFields.style.display === 'none') {
                inputFields.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
                miniInput.classList.add('hidden');
                inputSection.classList.remove('hidden');
            } else {
                inputFields.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
                if (globalData) {
                    updateMiniInput();
                    miniInput.classList.remove('hidden');
                    inputSection.classList.add('hidden');
                }
            }
        }
        
        function clearInputs() {
            document.getElementById('actaConstitutiva').value = '';
            document.getElementById('poder').value = '';
            document.getElementById('actasAsambleaInput').value = '';
            actasIds = [];
            renderActaTags();
        }
        
        function exportToPDF() {
            const element = document.getElementById('dictamen-content');
            const opt = {
                margin: 10,
                filename: `dictamen_juridico_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        
        async function fetchDocuments() {
            const actaConstitutiva = document.getElementById('actaConstitutiva').value.trim();
            const poder = document.getElementById('poder').value.trim();
            
            // Validar que al menos un campo tenga valor
            if (!actaConstitutiva && !poder && actasIds.length === 0) {
                alert('Por favor ingrese al menos un ID de documento');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            
            // Preparar IDs solo de los campos que tienen valor
            const recordIds = [];
            if (actaConstitutiva) recordIds.push(actaConstitutiva);
            if (poder) recordIds.push(poder);
            if (actasIds.length > 0) {
                recordIds.push(...actasIds);
            }
            
            try {
                const response = await fetch('https://dictaminacion-bancrea.nebuia.com/documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ record_ids: recordIds })
                });
                
                if (!response.ok) throw new Error('Error en la petición');
                
                globalData = await response.json();
                processDocuments();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener los documentos. Por favor verifique la conexión al servidor.');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function updateMiniInput() {
            const analyzedDocs = document.getElementById('analyzedDocs');
            analyzedDocs.innerHTML = '';
            
            if (globalData && globalData.processed_entities) {
                const docs = globalData.processed_entities.processed_documents || globalData.processed_entities;
                const docCounts = {};
                
                docs.forEach(doc => {
                    docCounts[doc.doc_type] = (docCounts[doc.doc_type] || 0) + 1;
                });
                
                Object.entries(docCounts).forEach(([type, count]) => {
                    const docInfo = documentTypes[type];
                    if (docInfo) {
                        analyzedDocs.innerHTML += `
                            <span class="doc-status doc-status-success">
                                <i class="fas ${docInfo.icon} mr-1 text-xs"></i>
                                ${count} ${docInfo.name}
                            </span>
                        `;
                    }
                });
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function processDocuments() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            // Minimizar input section
            toggleInputSection();
            
            const docs = globalData.processed_entities.processed_documents || globalData.processed_entities;
            
            // Separar documentos por tipo
            const documentsByType = {
                constitutiva: docs.filter(d => d.doc_type === 'acta_constitutiva'),
                poder: docs.filter(d => d.doc_type === 'poder'),
                asambleas: docs.filter(d => d.doc_type === 'actas_de_asamblea')
            };
            
            // Generar stats cards
            generateStatsCards(documentsByType);
            
            // Generar tabs
            generateTabs(documentsByType);
            
            // Renderizar el primer tab disponible
            const firstTab = Object.entries(documentsByType).find(([_, docs]) => docs.length > 0);
            if (firstTab) {
                showTab(firstTab[0]);
            }
            
            // Generar dictamen con final_structures
            renderDictamen(
                documentsByType.constitutiva[0], 
                documentsByType.poder[0], 
                documentsByType.asambleas,
                globalData.processed_entities.final_structures
            );
        }

        function generateStatsCards(documentsByType) {
            const statsCards = document.getElementById('statsCards');
            statsCards.innerHTML = '';
            
            // Total documentos
            const totalDocs = globalData.processed_entities.processed_documents.length;
            statsCards.innerHTML += `
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Documentos</p>
                            <p class="text-2xl font-semibold mt-1">${totalDocs}</p>
                        </div>
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-folder text-gray-600"></i>
                        </div>
                    </div>
                </div>
            `;
            
            // Cards por tipo de documento
            Object.entries(documentsByType).forEach(([type, docs]) => {
                if (docs.length > 0) {
                    let icon, name, bgColor;
                    
                    switch(type) {
                        case 'constitutiva':
                            icon = 'fa-building';
                            name = 'Acta Constitutiva';
                            bgColor = 'bg-blue-100';
                            break;
                        case 'poder':
                            icon = 'fa-stamp';
                            name = 'Poder';
                            bgColor = 'bg-green-100';
                            break;
                        case 'asambleas':
                            icon = 'fa-file-alt';
                            name = 'Asambleas';
                            bgColor = 'bg-purple-100';
                            break;
                    }
                    
                    statsCards.innerHTML += `
                        <div class="card p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">${name}</p>
                                    <p class="text-2xl font-semibold mt-1">${docs.length}</p>
                                </div>
                                <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                                    <i class="fas ${icon} text-gray-700"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function generateTabs(documentsByType) {
            const tabsContainer = document.getElementById('documentTabs');
            tabsContainer.innerHTML = '';
            
            Object.entries(documentsByType).forEach(([type, docs]) => {
                if (docs.length > 0) {
                    let icon, name;
                    
                    switch(type) {
                        case 'constitutiva':
                            icon = 'fa-building';
                            name = 'Acta Constitutiva';
                            break;
                        case 'poder':
                            icon = 'fa-stamp';
                            name = 'Poder';
                            break;
                        case 'asambleas':
                            icon = 'fa-file-alt';
                            name = 'Actas de Asamblea';
                            break;
                    }
                    
                    tabsContainer.innerHTML += `
                        <button onclick="showTab('${type}')" 
                                class="tab-btn pb-3 text-sm font-medium transition-all tab-inactive"
                                data-tab="${type}">
                            <i class="fas ${icon} mr-2"></i>
                            ${name} (${docs.length})
                        </button>
                    `;
                }
            });
        }

        function showTab(tabName) {
            // Update tab styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                }
            });
            
            activeTab = tabName;
            
            // Render content
            const docs = globalData.processed_entities.processed_documents || globalData.processed_entities;
            const constitutiva = docs.filter(d => d.doc_type === 'acta_constitutiva');
            const poder = docs.filter(d => d.doc_type === 'poder');
            const asambleas = docs.filter(d => d.doc_type === 'actas_de_asamblea');
            
            switch(tabName) {
                case 'constitutiva':
                    renderConstitutivaTab(constitutiva);
                    break;
                case 'poder':
                    renderPoderTab(poder);
                    break;
                case 'asambleas':
                    renderAsambleasTab(asambleas);
                    break;
            }
        }

        // Función para renderizar el tab de Acta Constitutiva con toda la información
        function renderConstitutivaTab(docs) {
            const content = document.getElementById('documents-content');
            content.innerHTML = '';
            
            docs.forEach(doc => {
                const data = doc.processed_data.extraccion;
                content.innerHTML += `
                    <div class="space-y-6">
                        <!-- Datos del documento -->
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <h4 class="font-medium text-gray-900 mb-2">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                Información del Documento
                            </h4>
                            <p class="text-sm text-gray-600 whitespace-pre-line">${doc.processed_data.datos_documento}</p>
                            
                            <!-- Detalles adicionales -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                                <div>
                                    <p class="text-xs text-gray-500">Escritura Pública</p>
                                    <p class="font-medium text-sm">${data.numero_escritura_o_póliza || 'No especificada'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Libro</p>
                                    <p class="font-medium text-sm">${data.libro || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Volumen</p>
                                    <p class="font-medium text-sm">${data.volumen || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Folio Mercantil Electrónico</p>
                                    <p class="font-medium text-sm">${data.folio_mercantil_electronico || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Fecha de Celebración</p>
                                    <p class="font-medium text-sm">${data.fecha_celebración || 'No especificada'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Notario</p>
                                    <p class="font-medium text-sm">${data.notario?.nombre || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Notaría Pública</p>
                                    <p class="font-medium text-sm">Número ${data.número_notaria_pública || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Lugar</p>
                                    <p class="font-medium text-sm">${data.lugar?.municipio || ''}, ${data.lugar?.estado || ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información General de la Sociedad -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                            <h4 class="font-semibold text-lg text-gray-900 mb-4">
                                <i class="fas fa-building text-blue-600 mr-2"></i>
                                ${data.nombre_o_razon_social || 'SOCIEDAD'}
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white rounded-lg p-4">
                                    <p class="text-xs text-gray-500 mb-1">Duración de la Sociedad</p>
                                    <p class="font-medium text-lg">${data.duración_sociedad || doc.processed_data.duracion_sociedad || 'No especificada'}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <p class="text-xs text-gray-500 mb-1">Tipo de Administración</p>
                                    <p class="font-medium">${data.sociedad?.tipo_administración || 'No especificado'}</p>
                                </div>
                                <div class="bg-white rounded-lg p-4 md:col-span-2">
                                    <p class="text-xs text-gray-500 mb-1">Domicilio Social</p>
                                    <p class="font-medium">${data.domicilio_social || 'No especificado'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Objeto Social -->
                        ${data.objeto_social ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-bullseye text-gray-600 mr-2"></i>
                                    Objeto Social
                                </h4>
                                <div class="bg-white rounded-lg p-4 max-h-64 overflow-y-auto">
                                    <p class="text-sm text-gray-700 whitespace-pre-line">${data.objeto_social}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Accionistas -->
                        ${data.accionistas && data.accionistas.length > 0 ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-users text-gray-600 mr-2"></i>
                                    Accionistas Fundadores
                                </h4>
                                <div class="bg-gray-50 rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="px-4 py-3 text-left font-medium text-gray-700">Nombre</th>
                                                <th class="px-4 py-3 text-center font-medium text-gray-700">RFC</th>
                                                <th class="px-4 py-3 text-center font-medium text-gray-700">Acciones</th>
                                                <th class="px-4 py-3 text-right font-medium text-gray-700">Valor</th>
                                                <th class="px-4 py-3 text-center font-medium text-gray-700">% Participación</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white">
                                            ${data.accionistas.map((acc, idx) => {
                                                // Calcular porcentaje de participación
                                                const valorNumerico = parseFloat(acc.valor?.replace(/[^\d.-]/g, '') || 0);
                                                const totalCapital = data.accionistas.reduce((sum, a) => {
                                                    return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                                }, 0);
                                                const porcentaje = totalCapital > 0 ? ((valorNumerico / totalCapital) * 100).toFixed(2) : '0';
                                                
                                                return `
                                                    <tr class="border-t border-gray-100 ${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                        <td class="px-4 py-3 font-medium">${acc.nombre || ''}</td>
                                                        <td class="px-4 py-3 text-center text-gray-600">${acc.rfc || 'No especificado'}</td>
                                                        <td class="px-4 py-3 text-center">${acc.acciones || ''}</td>
                                                        <td class="px-4 py-3 text-right font-medium">${acc.valor || ''}</td>
                                                        <td class="px-4 py-3 text-center">
                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                ${porcentaje}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                        <tfoot class="bg-gray-100">
                                            <tr>
                                                <td colspan="3" class="px-4 py-3 font-semibold text-right">Total Capital Social:</td>
                                                <td class="px-4 py-3 text-right font-semibold">
                                                    ${data.accionistas.reduce((sum, a) => {
                                                        return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                                    }, 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}
                                                </td>
                                                <td class="px-4 py-3 text-center font-semibold">100%</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Órgano de Administración -->
                        ${data.sociedad?.administradores || data.órgano_administración ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-user-tie text-gray-600 mr-2"></i>
                                    Órgano de Administración - ${data.sociedad?.tipo_administración || 'Consejo de Administración'}
                                </h4>
                                
                                <!-- Miembros del Consejo -->
                                ${data.sociedad?.administradores && data.sociedad.administradores.length > 0 ? `
                                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                        <h5 class="text-sm font-medium text-gray-700 mb-3">Miembros del Consejo</h5>
                                        <div class="space-y-2">
                                            ${data.sociedad.administradores.map((admin, idx) => `
                                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                                                    <div class="flex items-center">
                                                        <span class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-medium text-blue-700 mr-3">
                                                            ${idx + 1}
                                                        </span>
                                                        <div>
                                                            <p class="font-medium">${admin}</p>
                                                            <p class="text-sm text-gray-500">
                                                                ${idx === 0 ? 'Presidente' : idx === 1 ? 'Secretario' : 'Consejero'}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Funcionarios específicos -->
                                ${data.órgano_administración ? `
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        ${data.órgano_administración.nombre_presidente ? `
                                            <div class="bg-blue-50 rounded-lg p-4">
                                                <p class="text-xs text-gray-600 mb-1">Presidente del Consejo</p>
                                                <p class="font-medium">${data.órgano_administración.nombre_presidente}</p>
                                            </div>
                                        ` : ''}
                                        ${data.órgano_administración.nombre_secretario ? `
                                            <div class="bg-green-50 rounded-lg p-4">
                                                <p class="text-xs text-gray-600 mb-1">Secretario del Consejo</p>
                                                <p class="font-medium">${data.órgano_administración.nombre_secretario}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Facultades del Órgano de Administración -->
                                ${data.órgano_administración?.facultades && data.órgano_administración.facultades.length > 0 ? `
                                    <div class="bg-amber-50 rounded-lg p-4">
                                        <h5 class="text-sm font-medium text-gray-700 mb-3">Facultades del Órgano de Administración</h5>
                                        <div class="grid grid-cols-1 gap-2">
                                            ${data.órgano_administración.facultades.map(facultad => `
                                                <div class="flex items-start">
                                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-0.5 flex-shrink-0"></i>
                                                    <span class="text-sm text-gray-700">${facultad}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Órgano de Vigilancia -->
                        ${data.órgano_vigilacia_o_vigilación ? `
                            <div class="bg-purple-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-user-check text-purple-600 mr-2"></i>
                                    Órgano de Vigilancia
                                </h4>
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium">Comisario:</span> ${data.órgano_vigilacia_o_vigilación.nombre_comisario || 'Por designar en asamblea'}
                                </p>
                            </div>
                        ` : ''}
                        
                        <!-- Apoderados -->
                        ${data.apoderados ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-key text-gray-600 mr-2"></i>
                                    Apoderados y Poderes Otorgados
                                </h4>
                                
                                <!-- Lista de apoderados -->
                                ${data.apoderados.apoderados && data.apoderados.apoderados.length > 0 ? `
                                    <div class="mb-4">
                                        <h5 class="text-sm font-medium text-gray-700 mb-2">Apoderados Designados</h5>
                                        <div class="flex flex-wrap gap-2">
                                            ${data.apoderados.apoderados.map(ap => `
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                                    <i class="fas fa-user-shield mr-1"></i>
                                                    ${ap}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Detalle de poderes -->
                                ${data.apoderados.poderes && data.apoderados.poderes.length > 0 ? `
                                    <div class="space-y-3">
                                        ${data.apoderados.poderes.map((p, idx) => `
                                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                                <!-- Tipo de poder -->
                                                <div class="mb-3">
                                                    <h5 class="font-medium text-gray-900 flex items-center">
                                                        <span class="flex-shrink-0 w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-xs font-bold text-gray-700 mr-2">
                                                            ${idx + 1}
                                                        </span>
                                                        ${p.poder || 'Poder'}
                                                    </h5>
                                                </div>
                                                
                                                <!-- A quién se otorga -->
                                                ${p.a_quien_se_otorga && p.a_quien_se_otorga.length > 0 ? 
                                                    `<div class="mb-2">
                                                        <p class="text-sm text-gray-600">
                                                            <span class="font-medium">Otorgado a:</span>
                                                            <span class="ml-2">${p.a_quien_se_otorga.join(', ')}</span>
                                                        </p>
                                                    </div>` : ''}
                                                
                                                <!-- Forma de ejercer -->
                                                ${p.forma_de_ejercer ? 
                                                    `<div class="mb-2">
                                                        <p class="text-sm text-gray-600">
                                                            <span class="font-medium">Forma de ejercer:</span>
                                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                ${p.forma_de_ejercer}
                                                            </span>
                                                        </p>
                                                    </div>` : ''}
                                                
                                                <!-- Limitante -->
                                                ${p.limitante ? 
                                                    `<div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                                                        <p class="text-sm text-red-700">
                                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                                            <span class="font-medium">Limitante:</span> ${p.limitante}
                                                        </p>
                                                    </div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Sociedades Derivadas -->
                        ${data.sociedades_derivadas ? `
                            <div class="bg-indigo-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-sitemap text-indigo-600 mr-2"></i>
                                    Sociedades Derivadas
                                </h4>
                                ${data.sociedades_derivadas.nombre_nueva_sociedad ? `
                                    <p class="text-sm text-gray-700 mb-2">
                                        <span class="font-medium">Nueva sociedad:</span> ${data.sociedades_derivadas.nombre_nueva_sociedad}
                                    </p>
                                ` : ''}
                                ${data.sociedades_derivadas.nombre_sociedades && data.sociedades_derivadas.nombre_sociedades.length > 0 ? `
                                    <div>
                                        <p class="text-sm font-medium text-gray-700 mb-1">Sociedades relacionadas:</p>
                                        <ul class="list-disc list-inside text-sm text-gray-600">
                                            ${data.sociedades_derivadas.nombre_sociedades.map(soc => `
                                                <li>${soc}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Información adicional -->
                        <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                            <p class="text-xs text-gray-600 text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                Documento protocolizado y registrado conforme a las leyes mexicanas
                            </p>
                        </div>
                    </div>
                `;
            });
        }

        // Función mejorada para renderizar tab de Poder
        function renderPoderTab(docs) {
            const content = document.getElementById('documents-content');
            content.innerHTML = '';
            
            docs.forEach(doc => {
                const data = doc.processed_data.extraccion;
                const vigenciaCompleta = doc.processed_data.vigencia_poder;
                
                content.innerHTML += `
                    <div class="space-y-6">
                        <!-- Datos del documento -->
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <h4 class="font-medium text-gray-900 mb-2">
                                <i class="fas fa-info-circle text-green-600 mr-2"></i>
                                Información del Documento
                            </h4>
                            <p class="text-sm text-gray-600 whitespace-pre-line">${doc.processed_data.datos_documento}</p>
                            
                            <!-- Detalles adicionales -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                                <div>
                                    <p class="text-xs text-gray-500">Número de Poder</p>
                                    <p class="font-medium text-sm">${data.poder?.número_poder || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Libro</p>
                                    <p class="font-medium text-sm">${data.poder?.libro || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Volumen</p>
                                    <p class="font-medium text-sm">${data.poder?.volumen || 'No especificado'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Fecha de Otorgamiento</p>
                                    <p class="font-medium text-sm">${data.poder?.fecha_otorgamiento || 'No especificada'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Clave de Registro</p>
                                    <p class="font-medium text-sm">${data.clave_de_registro || 'No especificada'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Lugar</p>
                                    <p class="font-medium text-sm">${data.lugar?.municipio || ''}, ${data.lugar?.estado || ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información General del Poder -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Poderdante</p>
                                <p class="font-medium text-lg">${data.representante_sociedad_o_podernante || 'No especificado'}</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Vigencia</p>
                                <p class="font-medium text-lg">${data.vigencia_poder || 'No especificada'}</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Notario</p>
                                <p class="font-medium">${data.nombre_notario_titular || 'No especificado'}</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Notaría Pública</p>
                                <p class="font-medium">Número ${data.número_notaria || 'No especificado'}</p>
                            </div>
                        </div>
                        
                        <!-- Vigencia Completa -->
                        ${vigenciaCompleta ? `
                            <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                <h4 class="font-medium text-gray-900 mb-2">
                                    <i class="fas fa-calendar-alt text-amber-600 mr-2"></i>
                                    Vigencia Detallada
                                </h4>
                                <p class="text-sm text-gray-700">${vigenciaCompleta}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Poderes Otorgados -->
                        ${data.poderes && data.poderes.length > 0 ? `
                            <div>
                                <h4 class="font-medium text-gray-900 mb-3">
                                    <i class="fas fa-certificate text-gray-600 mr-2"></i>
                                    Poderes Otorgados
                                </h4>
                                <div class="space-y-4">
                                    ${data.poderes.map((p, idx) => `
                                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                            <div class="flex items-start">
                                                <span class="flex-shrink-0 w-8 h-8 bg-green-200 rounded-full flex items-center justify-center text-sm font-bold text-green-800 mr-3">
                                                    ${idx + 1}
                                                </span>
                                                <div class="flex-1">
                                                    <h5 class="font-medium text-gray-900 mb-2">${p.poder_otorgado || ''}</h5>
                                                    
                                                    ${p.a_favor_de && p.a_favor_de.length > 0 ? 
                                                        `<div class="mb-2">
                                                            <p class="text-sm text-gray-600">
                                                                <i class="fas fa-user mr-1"></i>
                                                                <span class="font-medium">A favor de:</span> ${p.a_favor_de.join(', ')}
                                                            </p>
                                                        </div>` : ''}
                                                    
                                                    ${p.forma_de_ejercer ? 
                                                        `<div class="mb-2">
                                                            <p class="text-sm text-gray-600">
                                                                <i class="fas fa-handshake mr-1"></i>
                                                                <span class="font-medium">Forma de ejercer:</span> 
                                                                <span class="ml-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                    ${p.forma_de_ejercer}
                                                                </span>
                                                            </p>
                                                        </div>` : ''}
                                                    
                                                    ${p.limitante ? 
                                                        `<div class="mt-3 p-3 bg-red-50 rounded text-sm text-red-700 border border-red-200">
                                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                                            <span class="font-medium">Limitante:</span> ${p.limitante}
                                                        </div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Información adicional del poder -->
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <h4 class="font-medium text-gray-900 mb-2">
                                <i class="fas fa-shield-alt text-blue-600 mr-2"></i>
                                Validez y Alcance
                            </h4>
                            <div class="space-y-2">
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                    Este poder se encuentra debidamente inscrito y registrado
                                </p>
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                    Los apoderados pueden ejercer las facultades conferidas según lo establecido
                                </p>
                                ${vigenciaCompleta && vigenciaCompleta.toLowerCase().includes('indefinida') ? 
                                    `<p class="text-sm text-gray-700">
                                        <i class="fas fa-infinity text-blue-500 mr-1"></i>
                                        El poder tiene vigencia indefinida
                                    </p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Función mejorada para renderizar tab de Asambleas
        function renderAsambleasTab(docs) {
            const content = document.getElementById('documents-content');
            content.innerHTML = '';
            
            docs.forEach((doc, docIdx) => {
                const data = doc.processed_data;
                const ext = data.extraccion;
                content.innerHTML += `
                    <div class="mb-8 ${docIdx > 0 ? 'pt-8 border-t-2 border-gray-300' : ''}">
                        <!-- Encabezado de la Asamblea -->
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <h3 class="font-semibold text-lg text-gray-900 mb-2">
                                <i class="fas fa-file-alt text-purple-600 mr-2"></i>
                               Asamblea ${docIdx + 1} - ${ext.tipo_asamblea || 'Asamblea General'}
                               </h3>
                          <p class="text-sm text-gray-600">
                              <i class="fas fa-calendar-alt mr-2"></i>
                              Fecha de celebración: <strong>${ext.fecha_de_celebracion || 'No especificada'}</strong>
                          </p>
                      </div>
                      
                      <!-- Datos del documento -->
                      <div class="bg-gray-50 rounded-lg p-4 mb-6">
                          <h4 class="font-medium text-gray-900 mb-2">
                              <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                              Información del Documento
                          </h4>
                          <p class="text-sm text-gray-600 whitespace-pre-line">${data.datos_documento}</p>
                          
                          <!-- Detalles adicionales del documento -->
                          <div class="grid grid-cols-2 gap-4 mt-4">
                              <div>
                                  <p class="text-xs text-gray-500">Escritura Pública</p>
                                  <p class="font-medium text-sm">${ext.numero_de_escritura_publica || 'No especificada'}</p>
                              </div>
                              <div>
                                  <p class="text-xs text-gray-500">Libro</p>
                                  <p class="font-medium text-sm">${ext.libro || 'No especificado'}</p>
                              </div>
                              <div>
                                  <p class="text-xs text-gray-500">Notario</p>
                                  <p class="font-medium text-sm">${ext.notario?.nombre || 'No especificado'}</p>
                              </div>
                              <div>
                                  <p class="text-xs text-gray-500">Notaría Pública</p>
                                  <p class="font-medium text-sm">Número ${ext.número_notaria_pública || 'No especificado'}</p>
                              </div>
                              <div>
                                  <p class="text-xs text-gray-500">Folio Mercantil Electrónico</p>
                                  <p class="font-medium text-sm">${ext.número_fme || 'No especificado'}</p>
                              </div>
                              <div>
                                  <p class="text-xs text-gray-500">Lugar</p>
                                  <p class="font-medium text-sm">${ext.lugar?.municipio || ''}, ${ext.lugar?.estado || ''}</p>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Orden del día / Asuntos -->
                      ${ext.asuntos && ext.asuntos.length > 0 ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-list-ol text-gray-400 mr-2"></i>
                                  Orden del Día
                              </h4>
                              <div class="bg-blue-50 rounded-lg p-4">
                                  <ol class="list-decimal list-inside space-y-2">
                                      ${ext.asuntos.map(asunto => `
                                          <li class="text-sm text-gray-700">${asunto}</li>
                                      `).join('')}
                                  </ol>
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Accionistas presentes -->
                      ${ext.accionistas && ext.accionistas.length > 0 ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-users text-gray-400 mr-2"></i>
                                  Accionistas Presentes
                              </h4>
                              <div class="bg-gray-50 rounded-lg overflow-hidden">
                                  <table class="w-full text-sm">
                                      <thead class="bg-gray-100">
                                          <tr>
                                              <th class="px-4 py-2 text-left font-medium text-gray-700">Accionista</th>
                                              <th class="px-4 py-2 text-center font-medium text-gray-700">No. Acciones</th>
                                              <th class="px-4 py-2 text-right font-medium text-gray-700">Valor</th>
                                              <th class="px-4 py-2 text-center font-medium text-gray-700">% Participación</th>
                                          </tr>
                                      </thead>
                                      <tbody class="bg-white">
                                          ${ext.accionistas.map(acc => {
                                              // Calcular porcentaje si es posible
                                              const totalAcciones = ext.accionistas.reduce((sum, a) => {
                                                  const num = parseInt(a.número_de_acciones?.replace(/[^\d]/g, '') || 0);
                                                  return sum + num;
                                              }, 0);
                                              const numAcciones = parseInt(acc.número_de_acciones?.replace(/[^\d]/g, '') || 0);
                                              const porcentaje = totalAcciones > 0 ? ((numAcciones / totalAcciones) * 100).toFixed(2) : '0';
                                              
                                              return `
                                                  <tr class="border-t border-gray-100">
                                                      <td class="px-4 py-3 font-medium">${acc.nombre || ''}</td>
                                                      <td class="px-4 py-3 text-center">${acc.número_de_acciones || ''}</td>
                                                      <td class="px-4 py-3 text-right">${acc.valor || ''}</td>
                                                      <td class="px-4 py-3 text-center">${porcentaje}%</td>
                                                  </tr>
                                              `;
                                          }).join('')}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Aumentos de Capital -->
                      ${ext.aumentos_capital?.aumentos && ext.aumentos_capital.aumentos.length > 0 ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-chart-line text-gray-400 mr-2"></i>
                                  Aumentos de Capital
                              </h4>
                              <div class="space-y-3">
                                  ${ext.aumentos_capital.aumentos.map((aumento, idx) => `
                                      <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                          <h5 class="font-medium text-gray-900 mb-2">Aumento ${idx + 1}</h5>
                                          <div class="grid grid-cols-2 gap-4 text-sm">
                                              ${aumento.fecha ? `
                                                  <div>
                                                      <span class="text-gray-600">Fecha:</span>
                                                      <span class="font-medium ml-2">${aumento.fecha}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.escritura_referencia ? `
                                                  <div>
                                                      <span class="text-gray-600">Escritura Ref:</span>
                                                      <span class="font-medium ml-2">${aumento.escritura_referencia}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.monto_anterior ? `
                                                  <div>
                                                      <span class="text-gray-600">Monto Anterior:</span>
                                                      <span class="font-medium ml-2">${aumento.monto_anterior}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.monto_aumento ? `
                                                  <div>
                                                      <span class="text-gray-600">Monto Aumento:</span>
                                                      <span class="font-medium ml-2 text-green-700">${aumento.monto_aumento}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.monto_total ? `
                                                  <div>
                                                      <span class="text-gray-600">Monto Total:</span>
                                                      <span class="font-medium ml-2">${aumento.monto_total}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.acciones_emitidas ? `
                                                  <div>
                                                      <span class="text-gray-600">Acciones Emitidas:</span>
                                                      <span class="font-medium ml-2">${aumento.acciones_emitidas}</span>
                                                  </div>
                                              ` : ''}
                                              ${aumento.valor_nominal ? `
                                                  <div>
                                                      <span class="text-gray-600">Valor Nominal:</span>
                                                      <span class="font-medium ml-2">${aumento.valor_nominal}</span>
                                                  </div>
                                              ` : ''}
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Consejo de Administración -->
                      ${ext.consejo_administración ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-user-tie text-gray-400 mr-2"></i>
                                  Consejo de Administración
                              </h4>
                              
                              <!-- Miembros -->
                              ${ext.consejo_administración.miembros && ext.consejo_administración.miembros.length > 0 ? `
                                  <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                      <h5 class="font-medium text-sm text-gray-700 mb-3">Miembros del Consejo</h5>
                                      <div class="space-y-2">
                                          ${ext.consejo_administración.miembros.map(miembro => `
                                              <div class="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                                                  <div>
                                                      <span class="font-medium">${miembro.nombre}</span>
                                                      <span class="ml-2 text-sm text-gray-600">(${miembro.rol})</span>
                                                  </div>
                                                  ${miembro.suplente ? `
                                                      <div class="text-sm text-gray-500">
                                                          Suplente: ${miembro.suplente}
                                                      </div>
                                                  ` : ''}
                                              </div>
                                          `).join('')}
                                      </div>
                                  </div>
                              ` : ''}
                              
                              <!-- Facultades del Consejo -->
                              ${ext.consejo_administración.facultades && ext.consejo_administración.facultades.length > 0 ? `
                                  <div class="bg-blue-50 rounded-lg p-4">
                                      <h5 class="font-medium text-sm text-gray-700 mb-3">Facultades del Consejo</h5>
                                      <ul class="list-disc list-inside space-y-1">
                                          ${ext.consejo_administración.facultades.map(facultad => `
                                              <li class="text-sm text-gray-700">${facultad}</li>
                                          `).join('')}
                                      </ul>
                                  </div>
                              ` : ''}
                          </div>
                      ` : ''}
                      
                      <!-- Comisario -->
                      ${ext.sociedad?.nombre_comisario ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-user-check text-gray-400 mr-2"></i>
                                  Órgano de Vigilancia
                              </h4>
                              <div class="bg-gray-50 rounded-lg p-4">
                                  <p class="text-sm">
                                      <span class="text-gray-600">Comisario:</span>
                                      <span class="font-medium ml-2">${ext.sociedad.nombre_comisario}</span>
                                  </p>
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Resoluciones -->
                      ${ext.resoluciones && ext.resoluciones.length > 0 ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-gavel text-gray-400 mr-2"></i>
                                  Resoluciones Adoptadas
                              </h4>
                              <div class="space-y-3">
                                  ${ext.resoluciones.map((res, idx) => `
                                      <div class="bg-amber-50 rounded-lg p-4 border-l-4 border-amber-400">
                                          <div class="flex items-start">
                                              <span class="flex-shrink-0 w-8 h-8 bg-amber-200 rounded-full flex items-center justify-center text-sm font-bold text-amber-800 mr-3">
                                                  ${idx + 1}
                                              </span>
                                              <p class="text-sm text-gray-700">${res}</p>
                                          </div>
                                      </div>
                                  `).join('')}
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Resoluciones detalladas (si existen) -->
                      ${data.resoluciones && data.resoluciones.length > 0 ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-file-contract text-gray-400 mr-2"></i>
                                  Detalle de Resoluciones
                              </h4>
                              <div class="space-y-4">
                                  ${data.resoluciones.map((resDetail, idx) => `
                                      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                          <h5 class="font-medium text-sm text-gray-900 mb-2">
                                              Resolución ${idx + 1}
                                          </h5>
                                          <p class="text-sm text-gray-700 mb-3">${resDetail.punto_resolucion}</p>
                                          
                                          ${resDetail.estructuras_relacionadas && resDetail.estructuras_relacionadas.length > 0 ? `
                                              <div class="mt-3 p-3 bg-white rounded">
                                                  <p class="text-xs text-gray-600 font-medium mb-2">Estructuras Relacionadas:</p>
                                                  ${resDetail.estructuras_relacionadas.map(est => `
                                                      ${est.apoderados ? `
                                                          <div class="text-xs text-gray-600">
                                                              <p class="font-medium">Apoderados afectados:</p>
                                                              <ul class="list-disc list-inside ml-2">
                                                                  ${est.apoderados.apoderados_generales?.map(ap => `
                                                                      <li>${ap}</li>
                                                                  `).join('') || ''}
                                                              </ul>
                                                          </div>
                                                      ` : ''}
                                                  `).join('')}
                                              </div>
                                          ` : ''}
                                      </div>
                                  `).join('')}
                              </div>
                          </div>
                      ` : ''}
                      
                      <!-- Apoderados -->
                      ${ext.apoderados ? `
                          <div class="mb-6">
                              <h4 class="font-medium text-gray-900 mb-3">
                                  <i class="fas fa-user-shield text-gray-400 mr-2"></i>
                                  Apoderados y Poderes
                              </h4>
                              
                              <!-- Lista de apoderados generales -->
                              ${ext.apoderados.apoderados_generales && ext.apoderados.apoderados_generales.length > 0 ? `
                                  <div class="mb-4">
                                      <h5 class="text-sm font-medium text-gray-700 mb-2">Apoderados Generales</h5>
                                      <div class="flex flex-wrap gap-2">
                                          ${ext.apoderados.apoderados_generales.map(ap => `
                                              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                                  <i class="fas fa-user mr-1"></i>
                                                  ${ap}
                                              </span>
                                          `).join('')}
                                      </div>
                                  </div>
                              ` : ''}
                              
                              <!-- Detalle de poderes por apoderado -->
                              ${ext.apoderados.poderes && ext.apoderados.poderes.length > 0 ? `
                                  <div class="space-y-4">
                                      ${ext.apoderados.poderes.map((poder, idx) => `
                                          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                              <div class="mb-3">
                                                  <h5 class="font-medium text-gray-900">
                                                      ${poder.a_quien_se_otorga ? poder.a_quien_se_otorga.join(', ') : 'Apoderado'}
                                                  </h5>
                                                  ${poder.forma_de_ejercer ? `
                                                      <p class="text-sm text-gray-600 mt-1">
                                                          <i class="fas fa-handshake mr-1"></i>
                                                          Forma de ejercer: <span class="font-medium">${poder.forma_de_ejercer}</span>
                                                      </p>
                                                  ` : ''}
                                              </div>
                                              
                                              <!-- Poderes otorgados -->
                                              ${poder.poderes && poder.poderes.length > 0 ? `
                                                  <div class="mb-3">
                                                      <p class="text-xs text-gray-600 font-medium mb-2">Facultades otorgadas:</p>
                                                      <div class="grid grid-cols-1 gap-2">
                                                          ${poder.poderes.map(p => `
                                                              <div class="flex items-start">
                                                                  <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5 text-xs"></i>
                                                                  <span class="text-sm text-gray-700">${p}</span>
                                                              </div>
                                                          `).join('')}
                                                      </div>
                                                  </div>
                                              ` : ''}
                                              
                                              <!-- Limitantes -->
                                              ${poder.limitante ? `
                                                  <div class="mt-3 p-3 bg-red-50 rounded border border-red-200">
                                                      <p class="text-sm text-red-700">
                                                          <i class="fas fa-exclamation-triangle mr-1"></i>
                                                          <span class="font-medium">Limitante:</span> ${poder.limitante}
                                                      </p>
                                                  </div>
                                              ` : ''}
                                              
                                              <!-- Poderes revocados -->
                                              ${poder.poderes_revocados && poder.poderes_revocados.length > 0 ? `
                                                  <div class="mt-3 p-3 bg-gray-100 rounded">
                                                      <p class="text-xs text-gray-600 font-medium mb-1">Poderes revocados:</p>
                                                      <ul class="list-disc list-inside text-sm text-gray-600">
                                                          ${poder.poderes_revocados.map(pr => `
                                                              <li>${pr}</li>
                                                          `).join('')}
                                                      </ul>
                                                  </div>
                                              ` : ''}
                                          </div>
                                      `).join('')}
                                  </div>
                              ` : ''}
                          </div>
                      ` : ''}
                      
                      <!-- Información adicional o notas -->
                      ${ext.notas || ext.observaciones ? `
                          <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                              <h4 class="font-medium text-gray-900 mb-2">
                                  <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>
                                  Notas y Observaciones
                              </h4>
                              <p class="text-sm text-gray-700">${ext.notas || ext.observaciones}</p>
                          </div>
                      ` : ''}
                  </div>
              `;
          });
      }

      // Función principal mejorada para generar el dictamen
      function renderDictamen(constitutiva, poder, asambleas, finalStructures) {
          const content = document.getElementById('dictamen-content');
          const fecha = new Date().toLocaleDateString('es-MX', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
          });
          
          // Determinar qué tipo de dictamen generar
          const tieneActa = !!constitutiva;
          const tienePoder = !!poder;
          const tieneAsambleas = asambleas && asambleas.length > 0;
          
          // Si solo hay poder, generar un dictamen simplificado
          if (!tieneActa && tienePoder && !tieneAsambleas) {
              renderDictamenPoder(poder, finalStructures, content, fecha);
              return;
          }
          
          // Si hay acta y asambleas pero no poder
          if (tieneActa && !tienePoder && tieneAsambleas) {
              renderDictamenActaAsambleas(constitutiva, asambleas, finalStructures, content, fecha);
              return;
          }
          
          // Si solo hay acta constitutiva
          if (tieneActa && !tienePoder && !tieneAsambleas) {
              renderDictamenSoloActa(constitutiva, finalStructures, content, fecha);
              return;
          }
          
          // Si hay cualquier otra combinación, generar dictamen completo tipo Bancrea
          renderDictamenCompleto(constitutiva, poder, asambleas, finalStructures, content, fecha);
      }

      // Nueva función para agrupar poderes por apoderado
      function renderPoderesAgrupados(poderes) {
          // Agrupar poderes por apoderado
          const poderesPorApoderado = {};
          
          poderes.forEach(poder => {
              const apoderados = poder.a_favor_de || ['Apoderado no especificado'];
              const poderInfo = {
                  tipo: poder.poder_otorgado || 'Poder General',
                  forma: poder.forma_de_ejercer || 'Individual',
                  limitante: poder.limitante || null
              };
              
              apoderados.forEach(apoderado => {
                  if (!poderesPorApoderado[apoderado]) {
                      poderesPorApoderado[apoderado] = [];
                  }
                  poderesPorApoderado[apoderado].push(poderInfo);
              });
          });
          
          // Renderizar por apoderado
          let html = '';
          Object.entries(poderesPorApoderado).forEach(([apoderado, poderesDelApoderado], idx) => {
              html += `
                  <div style="margin-bottom: 20px; ${idx > 0 ? 'border-top: 1px solid #e5e7eb; padding-top: 15px;' : ''}">
                      <h5 style="font-weight: bold; margin-bottom: 10px; color: #1e3a5f;">
                          ${apoderado}
                      </h5>
                      
                      <table class="dictamen-table">
                          <thead>
                              <tr>
                                  <th style="width: 60%;">Facultades</th>
                                  <th style="width: 20%;">Forma de Ejercer</th>
                                  <th style="width: 20%;">Limitaciones</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${poderesDelApoderado.map(poder => `
                                  <tr>
                                      <td>${poder.tipo}</td>
                                      <td style="text-align: center;">${poder.forma}</td>
                                      <td style="font-size: 9px; color: ${poder.limitante ? 'red' : 'inherit'};">
                                          ${poder.limitante || 'Sin limitaciones'}
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              `;
          });
          
          return html;
      }

      // Función para dictamen solo con poder
      function renderDictamenPoder(poder, finalStructures, content, fecha) {
          const poderData = poder.processed_data.extraccion;
          const folioMercantil = generateFolio();
          
          let html = `
              <div style="font-size: 11px; line-height: 1.5;">
                  <h1 style="text-align: center; font-size: 14px; font-weight: bold; margin: 20px 0;">
                      Dictamen de Poder Notarial
                  </h1>
                  
                  <div style="text-align: right; font-size: 10px; margin-bottom: 20px; font-weight: bold;">
                      FOLIO: ${folioMercantil}
                  </div>
                  
                  <!-- Información del Poder -->
                  <div class="dictamen-section">
                      <div class="dictamen-header">Datos del Poder</div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <tr>
                                  <td style="width: 30%; font-weight: bold;">Poderdante:</td>
                                  <td>${poderData.representante_sociedad_o_podernante || 'No especificado'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Número de Poder:</td>
                                  <td>${poderData.poder?.número_poder || 'No especificado'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Fecha de Otorgamiento:</td>
                                  <td>${poderData.poder?.fecha_otorgamiento || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Vigencia:</td>
                                  <td>${poderData.vigencia_poder || poder.processed_data.vigencia_poder || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Notario:</td>
                                  <td>${poderData.nombre_notario_titular || 'No especificado'} - Notaría ${poderData.número_notaria || ''}</td>
                              </tr>
                          </table>
                      </div>
                  </div>
                  
                  <!-- Apoderados y Facultades -->
                  ${poderData.poderes && poderData.poderes.length > 0 ? `
                      <div class="dictamen-section">
                          <div class="dictamen-header">Apoderados y Facultades Otorgadas</div>
                          <div class="dictamen-section-content">
                              ${renderPoderesAgrupados(poderData.poderes)}
                          </div>
                      </div>
                  ` : ''}
                  
                  <!-- Conclusiones para poder -->
                  <div style="margin-top: 30px; padding: 15px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                      <p style="font-weight: bold; margin-bottom: 10px;">Observaciones:</p>
                      <ul style="margin: 10px 0; padding-left: 20px; list-style-type: disc;">
                          <li style="margin: 5px 0;">El poder se encuentra debidamente protocolizado ante Notario Público.</li>
                          <li style="margin: 5px 0;">Se recomienda verificar la vigencia actual del poder y que no haya sido revocado.</li>
                          <li style="margin: 5px 0;">Los apoderados pueden ejercer las facultades conferidas según lo establecido en el documento.</li>
                      </ul>
                  </div>
                  
                  <div style="text-align: right; margin: 30px 0;">
                      <p>${poderData.lugar?.municipio || 'Ciudad'} a ${fecha}</p>
                  </div>
              </div>
          `;
          
          content.innerHTML = html;
      }

      // Función para dictamen con acta y asambleas (sin poder)
      function renderDictamenActaAsambleas(constitutiva, asambleas, finalStructures, content, fecha) {
          const actaData = constitutiva.processed_data.extraccion;
          const sociedadNombre = finalStructures?.company || actaData.nombre_o_razon_social || '[NOMBRE SOCIEDAD]';
          const folioMercantil = generateFolio();
          
          let html = `
              <div style="font-size: 11px; line-height: 1.5;">
                  <h1 style="text-align: center; font-size: 14px; font-weight: bold; margin: 20px 0;">
                      Dictamen Jurídico Corporativo<br>
                      ${sociedadNombre}
                  </h1>
                  
                  <div style="text-align: right; font-size: 10px; margin-bottom: 20px; font-weight: bold;">
                      FOLIO: ${folioMercantil}
                  </div>
                  
                  <!-- Datos de constitución -->
                  <div class="dictamen-section">
                      <div class="dictamen-header">1) Datos de Constitución</div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <tr>
                                  <td style="width: 30%; font-weight: bold;">Denominación:</td>
                                  <td>${sociedadNombre}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Escritura:</td>
                                  <td>${actaData.numero_escritura_o_póliza || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Fecha de Constitución:</td>
                                  <td>${actaData.fecha_celebración || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Duración:</td>
                                  <td>${actaData.duración_sociedad || 'INDEFINIDA'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Domicilio Social:</td>
                                  <td>${actaData.domicilio_social || 'No especificado'}</td>
                              </tr>
                          </table>
                      </div>
                  </div>
                  
                  <!-- Órganos vigentes -->
                  ${finalStructures?.vigent_structures ? `
                      ${finalStructures.vigent_structures.organo_administracion ? `
                          <div class="dictamen-section">
                              <div class="dictamen-header">2) Órgano de Administración Vigente</div>
                              <div class="dictamen-section-content">
                                  <table class="dictamen-table">
                                      ${finalStructures.vigent_structures.organo_administracion.data.miembros.map(miembro => `
                                          <tr>
                                              <td style="width: 30%; font-weight: bold;">${miembro.rol}:</td>
                                              <td>${miembro.nombre}</td>
                                          </tr>
                                      `).join('')}
                                  </table>
                              </div>
                          </div>
                      ` : ''}
                      
                      ${finalStructures.vigent_structures.accionistas ? `
                          <div class="dictamen-section">
                              <div class="dictamen-header">3) Estructura Accionaria Vigente</div>
                              <div class="dictamen-section-content">
                                  <table class="dictamen-table">
                                      <thead>
                                          <tr>
                                              <th>Accionista</th>
                                              <th>Acciones</th>
                                              <th>Valor</th>
                                              <th>Participación</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          ${finalStructures.vigent_structures.accionistas.data.map(acc => {
                                              const valorNumerico = parseFloat(acc.valor?.replace(/[^\d.-]/g, '') || 0);
                                              const totalCapital = finalStructures.vigent_structures.accionistas.data.reduce((sum, a) => {
                                                  return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                              }, 0);
                                              const porcentaje = totalCapital > 0 ? ((valorNumerico / totalCapital) * 100).toFixed(2) : '0';
                                              
                                              return `
                                                  <tr>
                                                      <td>${acc.nombre}</td>
                                                      <td style="text-align: center;">${acc.número_de_acciones || '-'}</td>
                                                      <td style="text-align: right;">${acc.valor}</td>
                                                      <td style="text-align: center;">${porcentaje}%</td>
                                                  </tr>
                                              `;
                                          }).join('')}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      ` : ''}
                  ` : ''}
                  
                  <!-- Resumen de asambleas -->
                  <div class="dictamen-section">
                      <div class="dictamen-header">4) Asambleas Celebradas</div>
                      <div class="dictamen-section-content">
                          <p>Se han analizado ${asambleas.length} acta(s) de asamblea:</p>
                          <ul style="list-style-type: disc; padding-left: 20px; margin-top: 10px;">
                              ${asambleas.map(asamblea => `
                                  <li>
                                      ${asamblea.processed_data.extraccion.tipo_asamblea || 'Asamblea'} - 
                                      ${asamblea.processed_data.extraccion.fecha_de_celebracion || 'Fecha no especificada'}
                                  </li>
                              `).join('')}
                          </ul>
                      </div>
                  </div>
                  
                  <div style="margin-top: 30px; padding: 15px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                      <p style="font-weight: bold; margin-bottom: 10px;">Nota:</p>
                      <p style="font-size: 10px;">Este dictamen refleja la estructura corporativa vigente con base en los documentos analizados.</p>
                  </div>
                  
                  <div style="text-align: right; margin: 30px 0;">
                      <p>${actaData.lugar?.municipio || 'Ciudad'} a ${fecha}</p>
                  </div>
              </div>
          `;
          
          content.innerHTML = html;
      }

      // Función para dictamen solo con acta constitutiva
      function renderDictamenSoloActa(constitutiva, finalStructures, content, fecha) {
          const actaData = constitutiva.processed_data.extraccion;
          const sociedadNombre = finalStructures?.company || actaData.nombre_o_razon_social || '[NOMBRE SOCIEDAD]';
          const folioMercantil = generateFolio();
          
          let html = `
              <div style="font-size: 11px; line-height: 1.5;">
                  <h1 style="text-align: center; font-size: 14px; font-weight: bold; margin: 20px 0;">
                      Dictamen de Acta Constitutiva<br>
                      ${sociedadNombre}
                  </h1>
                  
                  <div style="text-align: right; font-size: 10px; margin-bottom: 20px; font-weight: bold;">
                      FOLIO: ${folioMercantil}
                  </div>
                  
                  <!-- Información de constitución -->
                  <div class="dictamen-section">
                      <div class="dictamen-header">1) Información de Constitución</div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <tr>
                                  <td style="width: 35%; font-weight: bold;">Denominación Social:</td>
                                  <td>${sociedadNombre}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Escritura Pública:</td>
                                  <td>${actaData.numero_escritura_o_póliza || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Fecha de Constitución:</td>
                                  <td>${actaData.fecha_celebración || 'No especificada'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Duración:</td>
                                  <td>${actaData.duración_sociedad || 'INDEFINIDA'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Domicilio Social:</td>
                                  <td>${actaData.domicilio_social || 'No especificado'}</td>
                              </tr>
                              <tr>
                                  <td style="font-weight: bold;">Folio Mercantil:</td>
                                  <td>${actaData.folio_mercantil_electronico || 'No especificado'}</td>
                              </tr>
                          </table>
                      </div>
                  </div>
                  
                  <!-- Objeto social resumido -->
                  <div class="dictamen-section">
                      <div class="dictamen-header">2) Objeto Social</div>
                      <div class="dictamen-section-content">
                          <p style="font-size: 10px;">La sociedad cuenta con un objeto social amplio que incluye:</p>
                          <table class="dictamen-table" style="margin-top: 10px;">
                              <tr>
                                  <td>Celebrar contratos de crédito</td>
                                  <td style="width: 60px; text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Otorgar garantías</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Constituirse como obligado solidario</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                          </table>
                      </div>
                  </div>
                  
                  <!-- Estructura inicial -->
                  ${actaData.accionistas && actaData.accionistas.length > 0 ? `
                      <div class="dictamen-section">
                          <div class="dictamen-header">3) Accionistas Fundadores</div>
                          <div class="dictamen-section-content">
                              <table class="dictamen-table">
                                  <thead>
                                      <tr>
                                          <th>Accionista</th>
                                          <th>Participación</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      ${actaData.accionistas.map(acc => {
                                          const valorNumerico = parseFloat(acc.valor?.replace(/[^\d.-]/g, '') || 0);
                                          const totalCapital = actaData.accionistas.reduce((sum, a) => {
                                              return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                          }, 0);
                                          const porcentaje = totalCapital > 0 ? ((valorNumerico / totalCapital) * 100).toFixed(2) : '0';
                                          
                                          return `
                                              <tr>
                                                  <td>${acc.nombre}</td>
                                                  <td style="text-align: center;">${porcentaje}%</td>
                                              </tr>
                                          `;
                                      }).join('')}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  ` : ''}
                  
                  <!-- Órgano de administración inicial -->
                  ${actaData.sociedad?.administradores || actaData.órgano_administración ? `
                      <div class="dictamen-section">
                          <div class="dictamen-header">4) Órgano de Administración Inicial</div>
                          <div class="dictamen-section-content">
                              <p style="font-size: 10px; margin-bottom: 10px;">
                                  Tipo: ${actaData.sociedad?.tipo_administración || 'Consejo de Administración'}
                              </p>
                              ${actaData.sociedad?.administradores ? `
                                  <table class="dictamen-table">
                                      ${actaData.sociedad.administradores.map((admin, idx) => `
                                          <tr>
                                              <td style="width: 30%; font-weight: bold;">
                                                  ${idx === 0 ? 'Presidente' : idx === 1 ? 'Secretario' : 'Consejero'}:
                                              </td>
                                              <td>${admin}</td>
                                          </tr>
                                      `).join('')}
                                  </table>
                              ` : ''}
                          </div>
                      </div>
                  ` : ''}
                  
                  <div style="margin-top: 30px; padding: 15px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                      <p style="font-weight: bold; margin-bottom: 10px;">Observaciones:</p>
                      <ul style="margin: 10px 0; padding-left: 20px; list-style-type: disc; font-size: 10px;">
                          <li style="margin: 5px 0;">La sociedad se encuentra debidamente constituida conforme a las leyes mexicanas.</li>
                          <li style="margin: 5px 0;">Se recomienda verificar modificaciones posteriores mediante actas de asamblea.</li>
                      </ul>
                  </div>
                  
                  <div style="text-align: right; margin: 30px 0;">
                      <p>${actaData.lugar?.municipio || 'Ciudad'} a ${fecha}</p>
                  </div>
              </div>
          `;
          
          content.innerHTML = html;
      }

      // Función para dictamen completo tipo Bancrea (cuando hay múltiples documentos)
      function renderDictamenCompleto(constitutiva, poder, asambleas, finalStructures, content, fecha) {
          // Obtener todos los documentos ordenados cronológicamente
          const allDocs = [];
          if (constitutiva) allDocs.push(constitutiva);
          if (poder) allDocs.push(poder);
          if (asambleas) allDocs.push(...asambleas);
          
          // Ordenar por fecha
          allDocs.sort((a, b) => {
              const fechaA = extractDateFromDocument(a);
              const fechaB = extractDateFromDocument(b);
              return new Date(fechaA) - new Date(fechaB);
          });
          
          // Información básica
          const actaData = constitutiva?.processed_data?.extraccion;
          const sociedadNombre = finalStructures?.company || actaData?.nombre_o_razon_social || '[NOMBRE SOCIEDAD]';
          const numeroEscritura = actaData?.numero_escritura_o_póliza || '[NUMERO]';
          const folioMercantil = actaData?.folio_mercantil_electronico || generateFolio();
          
          // Generar dictamen estilo Bancrea
          let html = `
              <div style="font-size: 11px; line-height: 1.5;">
                  <h1 style="text-align: center; font-size: 14px; font-weight: bold; margin: 20px 0;">
                      Dictamen Jurídico para Apertura de Cuenta y<br>
                      formalización de Crédito / Arrendamiento
                  </h1>
                  
                  <div style="text-align: right; font-size: 10px; margin-bottom: 20px; font-weight: bold;">
                      FOLIO: ${folioMercantil}
                  </div>
          `;
          
          // 1. Denominación y tipo de sociedad
          if (constitutiva) {
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">
                          1) Denominación y tipo de Sociedad: ${sociedadNombre}, S.A. DE C.V. (Esc.${numeroEscritura})
                      </div>
                  </div>
              `;
          }
          
          // 2. Documentos dictaminados (cronológico)
          html += `
              <div class="dictamen-section">
                  <div class="dictamen-header">Documentos dictaminados</div>
                  <div class="dictamen-section-content">
          `;
          
          allDocs.forEach((doc, idx) => {
              const isLast = idx === allDocs.length - 1;
              html += `
                  <div class="documento-chronologico" style="${!isLast ? 'border-bottom: 1px dashed #d1d5db;' : ''}">
                      ${doc.processed_data.datos_documento}
                  </div>
              `;
          });
          
          html += `
                  </div>
              </div>
          `;
          
          // Solo continuar con el dictamen completo si hay acta constitutiva
          if (constitutiva) {
              // 3. Duración
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">2) Duración: (Esc.${numeroEscritura})</div>
                      <div class="dictamen-section-content">
                          ${actaData?.duración_sociedad || 'INDEFINIDA'}
                      </div>
                  </div>
              `;
              
              // 4. Domicilio social
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">3) Domicilio social: (Esc.${numeroEscritura})</div>
                      <div class="dictamen-section-content">
                          ${actaData?.domicilio_social || '[DOMICILIO]'}
                      </div>
                  </div>
              `;
              
              // 5. Objeto Social
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">4) Objeto Social: (Esc.${numeroEscritura})</div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <tr>
                                  <td style="width: 80%;">Celebrar contratos de crédito</td>
                                  <td style="width: 20%; text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Otorgar garantías a favor de la sociedad</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Garantizar obligaciones a cargo de terceros</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Otorgar avales</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                              <tr>
                                  <td>Constituirse como obligado/deudor solidario</td>
                                  <td style="text-align: center;">Sí</td>
                              </tr>
                          </table>
                      </div>
                  </div>
              `;
              
              // 6. Limitaciones de los Estatutos
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">
                          5) Limitaciones de los Estatutos Sociales relativos a la celebración de contratos de crédito, 
                          arrendamientos y/u otorgamiento de garantías (Esc.N/A)
                      </div>
                      <div class="dictamen-section-content">
                          N/A
                      </div>
                  </div>
              `;
          }
          
          // 7. Órgano de Administración vigente
          if (finalStructures?.vigent_structures?.organo_administracion) {
              const organo = finalStructures.vigent_structures.organo_administracion;
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">
                          6) Órgano de Administración (CONSEJO DE ADMINISTRACIÓN) (Esc.${organo.source_deed})
                      </div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              ${organo.data.miembros.map(miembro => `
                                  <tr>
                                      <td style="width: 30%; font-weight: bold;">${miembro.rol}:</td>
                                      <td>${miembro.nombre}</td>
                                  </tr>
                              `).join('')}
                          </table>
                      </div>
                  </div>
              `;
          }
          
          // 8. Órgano de Vigilancia vigente
          if (finalStructures?.vigent_structures?.organo_vigilancia) {
              const vigilancia = finalStructures.vigent_structures.organo_vigilancia;
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">
                          7) Órgano de Vigilancia actual (COMISARIO) (Esc.${vigilancia.source_deed})
                      </div>
                      <div class="dictamen-section-content">
                          ${vigilancia.data.nombre_comisario}
                      </div>
                  </div>
              `;
          }
          
          // 9. Facultades del Órgano de Administración
          if (constitutiva && actaData?.órgano_administración?.facultades) {
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">8) Facultades del Órgano de Administración: (Esc.${numeroEscritura})</div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <thead>
                                  <tr>
                                      <th>Facultades</th>
                                      <th style="width: 60px; text-align: center;">Sí/No</th>
                                      <th style="width: 120px;">Forma de Ejercer</th>
                                      <th>Comentarios</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <tr>
                                      <td>Poder General para Actos de Administración</td>
                                      <td style="text-align: center;">Sí</td>
                                      <td>Conjuntamente</td>
                                      <td></td>
                                  </tr>
                                  <tr>
                                      <td>Poder General para Actos de Dominio</td>
                                      <td style="text-align: center;">Sí</td>
                                      <td>Conjuntamente</td>
                                      <td></td>
                                  </tr>
                                  <tr>
                                      <td>Poder General Cambiario</td>
                                      <td style="text-align: center;">Sí</td>
                                      <td>Conjuntamente</td>
                                      <td></td>
                                  </tr>
                                  <tr>
                                      <td>Delegar</td>
                                      <td style="text-align: center;">Sí</td>
                                      <td>Conjuntamente</td>
                                      <td></td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              `;
          }
          
          // 10. Apoderados vigentes
          if (finalStructures?.vigent_structures?.apoderados) {
              const apoderados = finalStructures.vigent_structures.apoderados;
              html += `<div style="page-break-inside: avoid;">`;
              
              apoderados.data.forEach((apoderado, idx) => {
                  html += `
                      <div class="dictamen-section" style="margin-top: 20px;">
                          <div class="dictamen-header">
                              9) Apoderados: (${apoderado.nombre} Esc.${apoderados.source_deed})
                          </div>
                          <div class="dictamen-section-content">
                              <table class="dictamen-table">
                                  <thead>
                                      <tr>
                                          <th>Facultades</th>
                                          <th style="width: 60px; text-align: center;">Sí/No</th>
                                          <th style="width: 120px;">Forma de Ejercer</th>
                                          <th>Comentarios</th>
                                      </tr>
                                  </thead>
                                  <tbody>
              `;
              
              // Mapear poderes a la tabla
              const poderesMap = {
                  'Para ejercer actos de dominio': 'Poder General para Actos de Dominio',
                  'Para pleitos y cobranzas': 'Poder General para Pleitos y Cobranzas',
                  'Para administrar bienes': 'Poder General para Actos de Administración',
                  'Poder general cambiario': 'Poder General Cambiario'
              };
              
              // Verificar cada tipo de poder
              Object.entries(poderesMap).forEach(([key, label]) => {
                  const tienePoder = apoderado.poderes.some(p => 
                      p.toLowerCase().includes(key.toLowerCase())
                  );
                  
                  html += `
                      <tr>
                          <td>${label}</td>
                          <td style="text-align: center;">${tienePoder ? 'Sí' : 'No'}</td>
                          <td>${tienePoder ? 'Individual' : ''}</td>
                          <td style="font-size: 9px;">${apoderado.limitante || ''}</td>
                      </tr>
                  `;
              });
              
              html += `
                                  </tbody>
                              </table>
                          </div>
                      </div>
              `;
              });
              
              html += `</div>`;
          } else if (poder) {
              // Si no hay apoderados vigentes pero hay un poder, mostrarlo
              const poderData = poder.processed_data.extraccion;
              if (poderData.poderes && poderData.poderes.length > 0) {
                  html += `
                      <div class="dictamen-section">
                          <div class="dictamen-header">9) Apoderados</div>
                          <div class="dictamen-section-content">
                              ${renderPoderesAgrupados(poderData.poderes)}
                          </div>
                      </div>
                  `;
              }
          }
          
          // 11. Accionistas vigentes
          if (finalStructures?.vigent_structures?.accionistas) {
              const accionistas = finalStructures.vigent_structures.accionistas;
              html += `
                  <div class="dictamen-section">
                      <div class="dictamen-header">
                          10) Accionistas y Acciones/Valores Actuales (Esc.${accionistas.source_deed})
                      </div>
                      <div class="dictamen-section-content">
                          <table class="dictamen-table">
                              <thead>
                                  <tr>
                                      <th>Accionistas</th>
                                      <th>Acciones Serie "A"</th>
                                      <th>Acciones Serie "B"</th>
                                      <th>Valor</th>
                                      <th style="text-align: center;">%</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${accionistas.data.map(acc => {
                                      // Calcular porcentaje
                                      const valorNumerico = parseFloat(acc.valor?.replace(/[^\d.-]/g, '') || 0);
                                      const totalCapital = accionistas.data.reduce((sum, a) => {
                                          return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                      }, 0);
                                      const porcentaje = totalCapital > 0 ? ((valorNumerico / totalCapital) * 100).toFixed(2) : '0';
                                      
                                      return `
                                          <tr>
                                              <td>${acc.nombre}</td>
                                              <td style="text-align: center;">${acc.número_de_acciones || '-'}</td>
                                              <td style="text-align: center;">-</td>
                                              <td style="text-align: right;">${acc.valor}</td>
                                              <td style="text-align: center;">${porcentaje}%</td>
                                          </tr>
                                      `;
                                  }).join('')}
                              </tbody>
                              <tfoot>
                                  <tr style="font-weight: bold;">
                                      <td>Total</td>
                                      <td colspan="2"></td>
                                      <td style="text-align: right;">
                                          ${accionistas.data.reduce((sum, a) => {
                                              return sum + parseFloat(a.valor?.replace(/[^\d.-]/g, '') || 0);
                                          }, 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}
                                      </td>
                                      <td style="text-align: center;">100%</td>
                                  </tr>
                              </tfoot>
                          </table>
                      </div>
                  </div>
              `;
          }
          
          // Conclusiones
          html += `
              <div style="margin-top: 30px; padding: 15px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                  <p style="font-weight: bold; margin-bottom: 10px;">Conclusiones:</p>
                  <ul style="margin: 10px 0; padding-left: 20px; list-style-type: disc;">
                      <li style="margin: 5px 0;">La Sociedad Mercantil objeto del presente dictamen se encuentra debidamente constituida bajo las leyes mexicanas.</li>
                    <li style="margin: 5px 0;">Se reconocen las facultades conferidas al Órgano de Administración y Apoderados.</li>
                      <li style="margin: 5px 0;">Favor de verificar con el cliente la subsistencia de los cargos y poderes otorgados.</li>
                      <li style="margin: 5px 0;">El presente dictamen se elaboró con los documentos proporcionados por el ejecutivo al Departamento Jurídico.</li>
                  </ul>
              </div>
              
              <div style="text-align: right; margin: 30px 0;">
                  <p>${actaData?.lugar?.municipio || 'Ciudad'} a ${fecha}</p>
              </div>
              
              <div style="text-align: center; margin-top: 50px;">
                  <p>Atentamente</p>
                  <div style="border-top: 1px solid black; width: 200px; margin: 40px auto 10px;"></div>
                  <p>Lic. ______________________________</p>
                  <p>Departamento Jurídico</p>
              </div>
          </div>
          `;
          
          content.innerHTML = html;
      }

      // Función auxiliar para extraer fecha de documento
      function extractDateFromDocument(doc) {
          const data = doc.processed_data;
          if (data.extraccion?.fecha_celebración) return data.extraccion.fecha_celebración;
          if (data.extraccion?.fecha_de_celebracion) return data.extraccion.fecha_de_celebracion;
          if (data.extraccion?.poder?.fecha_otorgamiento) return data.extraccion.poder.fecha_otorgamiento;
          
          // Intentar extraer fecha del texto
          const match = data.datos_documento.match(/fecha (\d{1,2} de \w+ de(?:l)? \d{4})/i);
          if (match) return match[1];
          
          return '2000-01-01'; // Fecha por defecto
      }

      function generateFolio() {
          const date = new Date();
          return `DJ-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random() * 1000).toString().padStart(3,'0')}`;
      }

      // CSS para impresión
      const printStyles = `
          @media print {
              body { background: white; }
              header { display: none !important; }
              .no-print { display: none !important; }
              .card { border: none !important; box-shadow: none !important; }
              .dictamen-section { page-break-inside: avoid; }
              #dictamen-content { padding: 0 !important; }
              #inputSection { display: none !important; }
              #miniInput { display: none !important; }
              #statsCards { display: none !important; }
              #documentTabs { display: none !important; }
              #documents-content { display: none !important; }
              .lg\\:col-span-2 { display: none !important; }
              .border-b.border-gray-200.px-6.py-4 { display: none !important; }
          }
      `;
      
      const styleSheet = document.createElement("style");
      styleSheet.textContent = printStyles;
      document.head.appendChild(styleSheet);
  </script>
</body>
</html>
